# Frontend Server for E2E Testing
# Builds production bundle and serves via preview server
# Note: console.error/warn stripping is configured in vite.config.js (terser)

FROM node:20-alpine

# Install curl for health checks
RUN apk add --no-cache curl

WORKDIR /app

# Copy package files
COPY desktop-app/package*.json ./

# Install dependencies
RUN npm ci

# Copy source files
COPY desktop-app/src ./src
COPY desktop-app/public ./public
COPY desktop-app/index.html ./
COPY desktop-app/vite.config.js ./
COPY desktop-app/tailwind.config.js ./
COPY desktop-app/postcss.config.js ./

# Build production bundle
# IMPORTANT: VITE_* env vars are embedded at BUILD time, not runtime
# Must use actual E2E test API key here to match backend's API_KEYS env var
ENV VITE_API_URL=http://api:3000
ENV VITE_API_KEY=test_api_key_e2e.e2e_secret_123
RUN npx vite build

# Expose preview server port
EXPOSE 5173

# Serve production build with Vite preview server
CMD npx vite preview --host 0.0.0.0 --port 5173
