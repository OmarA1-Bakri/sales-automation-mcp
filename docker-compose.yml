version: '3.8'

services:
  rtgs-sales-automation:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rtgs-sales-automation
    ports:
      - "3000:3000"  # Sales Automation API
      - "3456:3456"  # Alternate API port
      - "5173:5173"  # Desktop App Dev Server
    environment:
      # ============================================================================
      # AI PROVIDERS
      # ============================================================================
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - AI_PROVIDER=${AI_PROVIDER:-anthropic}

      # ============================================================================
      # CRM INTEGRATION
      # ============================================================================
      - HUBSPOT_API_KEY=${HUBSPOT_API_KEY:-}
      - HUBSPOT_API_TOKEN=${HUBSPOT_API_TOKEN:-}
      - HUBSPOT_CLIENT_SECRET=${HUBSPOT_CLIENT_SECRET:-}
      - HUBSPOT_APP_ID=${HUBSPOT_APP_ID:-}
      - HUBSPOT_SIGNATURE_SECRET=${HUBSPOT_SIGNATURE_SECRET:-}
      - HUBSPOT_PRIVATE_APP_TOKEN=${HUBSPOT_PRIVATE_APP_TOKEN:-}

      # ============================================================================
      # EMAIL/OUTREACH PROVIDERS
      # ============================================================================
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-lemlist}
      - LEMLIST_API_KEY=${LEMLIST_API_KEY:-}
      - LEMLIST_WEBHOOK_SECRET=${LEMLIST_WEBHOOK_SECRET:-}
      - POSTMARK_API_KEY=${POSTMARK_API_KEY:-}
      - POSTMARK_SERVER_TOKEN=${POSTMARK_SERVER_TOKEN:-}
      - POSTMARK_WEBHOOK_SECRET=${POSTMARK_WEBHOOK_SECRET:-}
      - POSTMARK_SENDER_EMAIL=${POSTMARK_SENDER_EMAIL:-}

      # ============================================================================
      # LINKEDIN PROVIDERS
      # ============================================================================
      - LINKEDIN_PROVIDER=${LINKEDIN_PROVIDER:-lemlist}
      - LINKEDIN_SESSION_COOKIE=${LINKEDIN_SESSION_COOKIE:-}
      - PHANTOMBUSTER_API_KEY=${PHANTOMBUSTER_API_KEY:-}
      - PHANTOMBUSTER_WEBHOOK_SECRET=${PHANTOMBUSTER_WEBHOOK_SECRET:-}

      # ============================================================================
      # DATA ENRICHMENT
      # ============================================================================
      - EXPLORIUM_API_KEY=${EXPLORIUM_API_KEY:-}

      # ============================================================================
      # VIDEO GENERATION
      # ============================================================================
      - VIDEO_PROVIDER=${VIDEO_PROVIDER:-heygen}
      - HEYGEN_API_KEY=${HEYGEN_API_KEY:-}
      - HEYGEN_WEBHOOK_SECRET=${HEYGEN_WEBHOOK_SECRET:-}

      # ============================================================================
      # API SERVER CONFIG
      # ============================================================================
      - PORT=${PORT:-3000}
      - API_SERVER_PORT=${API_SERVER_PORT:-3000}
      - API_KEYS=${API_KEYS:-}
      - API_SECRET_KEY=${API_SECRET_KEY:-}
      - NODE_ENV=${NODE_ENV:-development}
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # ============================================================================
      # DATABASE CONFIG
      # ============================================================================
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=rtgs_sales_automation
      - POSTGRES_USER=rtgs_user
      - POSTGRES_PASSWORD=rtgs_password_dev

      # ============================================================================
      # REDIS CONFIG
      # ============================================================================
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}

      # ============================================================================
      # RATE LIMITING
      # ============================================================================
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-15}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - CHAT_RATE_LIMIT_MAX=${CHAT_RATE_LIMIT_MAX:-10}

      # ============================================================================
      # AUTOMATION SETTINGS
      # ============================================================================
      - AUTO_ENRICH_ON_IMPORT=${AUTO_ENRICH_ON_IMPORT:-false}
      - AUTO_SYNC_AFTER_ENRICH=${AUTO_SYNC_AFTER_ENRICH:-false}

      # ============================================================================
      # SSL/HTTPS
      # ============================================================================
      - SSL_KEY_PATH=${SSL_KEY_PATH:-}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-}

    volumes:
      # Mount source code for live development
      - ./sales-automation-api:/app/sales-automation-api
      - ./desktop-app:/app/desktop-app

      # Persist data
      - sales-data:/app/.sales-automation

      # Exclude node_modules from mount (use container's version)
      - /app/sales-automation-api/node_modules
      - /app/desktop-app/node_modules

    command: /app/start.sh

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - rtgs-network

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  postgres:
    image: postgres:16-alpine
    container_name: rtgs-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=rtgs_sales_automation
      - POSTGRES_USER=rtgs_user
      - POSTGRES_PASSWORD=rtgs_password_dev
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./sales-automation-api/src/db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rtgs_user -d rtgs_sales_automation"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - rtgs-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: rtgs-redis
    ports:
      - "6379:6379"
    command: >
      sh -c '
        if [ -n "$REDIS_PASSWORD" ]; then
          redis-server --requirepass "$REDIS_PASSWORD"
        else
          redis-server
        fi
      '
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - rtgs-network
    restart: unless-stopped

volumes:
  sales-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local

networks:
  rtgs-network:
    driver: bridge
